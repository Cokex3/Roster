define(["./core","./var/slice","./callbacks"],function(e,t){"use strict";function n(e){return e}function i(e){throw e}function r(t,n,i,r){var s;try{t&&e.isFunction(s=t.promise)?s.call(t).done(n).fail(i):t&&e.isFunction(s=t.then)?s.call(t,n,i):n.apply(void 0,[t].slice(r))}catch(t){i.apply(void 0,[t])}}return e.extend({Deferred:function(t){var r=[["notify","progress",e.Callbacks("memory"),e.Callbacks("memory"),2],["resolve","done",e.Callbacks("once memory"),e.Callbacks("once memory"),0,"resolved"],["reject","fail",e.Callbacks("once memory"),e.Callbacks("once memory"),1,"rejected"]],s="pending",o={state:function(){return s},always:function(){return a.done(arguments).fail(arguments),this},"catch":function(e){return o.then(null,e)},pipe:function(){var t=arguments;return e.Deferred(function(n){e.each(r,function(i,r){var s=e.isFunction(t[r[4]])&&t[r[4]];a[r[1]](function(){var t=s&&s.apply(this,arguments);t&&e.isFunction(t.promise)?t.promise().progress(n.notify).done(n.resolve).fail(n.reject):n[r[0]+"With"](this,s?[t]:arguments)})}),t=null}).promise()},then:function(t,s,o){function l(t,r,s,o){return function(){var u=this,c=arguments,f=function(){var f,d;if(!(a>t)){if(f=s.apply(u,c),f===r.promise())throw new TypeError("Thenable self-resolution");d=f&&("object"==typeof f||"function"==typeof f)&&f.then,e.isFunction(d)?o?d.call(f,l(a,r,n,o),l(a,r,i,o)):(a++,d.call(f,l(a,r,n,o),l(a,r,i,o),l(a,r,n,r.notifyWith))):(s!==n&&(u=void 0,c=[f]),(o||r.resolveWith)(u,c))}},d=o?f:function(){try{f()}catch(n){e.Deferred.exceptionHook&&e.Deferred.exceptionHook(n,d.stackTrace),t+1>=a&&(s!==i&&(u=void 0,c=[n]),r.rejectWith(u,c))}};t?d():(e.Deferred.getStackHook&&(d.stackTrace=e.Deferred.getStackHook()),window.setTimeout(d))}}var a=0;return e.Deferred(function(a){r[0][3].add(l(0,a,e.isFunction(o)?o:n,a.notifyWith)),r[1][3].add(l(0,a,e.isFunction(t)?t:n)),r[2][3].add(l(0,a,e.isFunction(s)?s:i))}).promise()},promise:function(t){return null!=t?e.extend(t,o):o}},a={};return e.each(r,function(e,t){var n=t[2],i=t[5];o[t[1]]=n.add,i&&n.add(function(){s=i},r[3-e][2].disable,r[0][2].lock),n.add(t[3].fire),a[t[0]]=function(){return a[t[0]+"With"](this===a?void 0:this,arguments),this},a[t[0]+"With"]=n.fireWith}),o.promise(a),t&&t.call(a,a),a},when:function(n){var i=arguments.length,s=i,o=Array(s),a=t.call(arguments),l=e.Deferred(),u=function(e){return function(n){o[e]=this,a[e]=arguments.length>1?t.call(arguments):n,--i||l.resolveWith(o,a)}};if(1>=i&&(r(n,l.done(u(s)).resolve,l.reject,!i),"pending"===l.state()||e.isFunction(a[s]&&a[s].then)))return l.then();for(;s--;)r(a[s],u(s),l.reject);return l.promise()}}),e});